---
title: "IMRaD report for Karl"
author: "Alexandra Stephenson"
date: today
format: 
  html:
    self-contained: true
    df-print: tibble
editor_options:
  chunk_output_type: console
execute:
  warning: false
  message: false
  echo: false
bibliography: references.bib
---

# A predictive model of gene expression

-   Y = gene expression

-   X = concentration (numerical), treatment (factor, 2 levels), cell line (factor, 2 levels)

-   grouping = sheet names

```{r}
pacman::p_load(tidyverse, readr)
theme_set(theme_light())
data <- read_csv("data/2023-03-01_gene-data.csv")
data_long <- data %>%
  mutate(CL = `cell line`,
         treat = treatment) %>%
  unite(`cell line`, `treat`, sep = "; ", col = "grouping") %>%
  pivot_longer(cols = 4:14, names_to = "concentration", values_to = "GE") %>%
  filter(GE >= 0) %>%
  mutate(concentration = as.integer(concentration),
         GL = as.factor(sheet_names),
         CL = as.factor(CL),
         treatment = as.factor(treatment),
         grouping = as.factor(grouping))
```

```{r}
pacman::p_load(lme4)
```

```{r}
test1 <- lmer(GE ~ concentration + (1|GL), data = data_long, na.action = na.omit)
summary(test1)
test2 <- lmer(GE ~ concentration + treatment*CL + (1|GL), data = data_long, na.action = na.omit)
summary(test2)
test3 <- lmer(GE ~ concentration*treatment*CL + (1|GL), data = data_long, na.action = na.omit)
summary(test3)
test4 <- lmer(GE ~ concentration*treatment + (1|GL), data = data_long, na.action = na.omit)
summary(test4)
test5 <- lmer(GE ~ concentration*treatment + CL + (1|GL), data = data_long, na.action = na.omit)
summary(test5)
AIC(test1, test2, test3, test4, test5)
BIC(test1, test2, test3, test4, test5)
```

Cell line does not appear (from the EDA plots) to have a large impact on the slope of `GE ~ concentration`, so removing the interaction terms with cell line (lower AIC and BIC may just be due to overfitting). Removing this option leaves `GE ~ concentration + (1|GL)`, `GE ~ concentration*treatment + (1|GL)` and `GE ~ concentration*treatment + CL + (1|GL)` as the possible models. Of these, the last two models have the best AIC and BIC. However, there is not much difference between the AIC and BIC for these two models, so the model with fewer degrees of freedom is chosen: `GE ~ concentration*treatment + (1|GL)`. **CHECK THIS**

# Introduction

# Method

-   R language [@r-2022]
-   tidyverse [@tidyverse]
-   rstatix [@rstatix]
-   ggpubr [@ggpubr]
-   patchwork [@patchwork]
-   showtext [@showtext]
-   ggrepel [@ggrepel]
-   lme4 [@lme4]

# Results

```{r fig-ge-conc-grouping, fig.cap = "A plot of gene expression as a function of concentration, coloured by cell line (wild-type or cell-type 101) and treatment (placebo or activating factor 42)."}
data_long %>%
  ggplot(aes(x = concentration, y = GE, color = grouping)) +
  geom_point() +
  ylim(0, NA) +
  harrypotter::scale_color_hp_d("Ravenclaw") +
  labs(x = "Concentration (mg/ml)",
       y = "Gene expression",
       color = "Cell Line; Treatment")
```

The data is plotted in @fig-ge-conc-grouping, with gene expression on the y axis and concentration on the x axis, with the data points coloured by cell line and treatment. From this plot, it can be seen that there appear to be differences between (cell-type 101, placebo) and (wild-type, placebo) and the other two pairs of cell line and treatment. However, there does not appear to be a difference between (cell-type 101, activating factor 42) and (wild-type, activating factor 42). This suggests that for the placebo treatment, cell line has an impact on gene expression, but for the activating factor, cell line may not have an impact on gene expression. From @fig-ge-conc-grouping, it can be seen that there does appear to be a relationship between concentration and gene expression, which suggests that concentration is a predictor of gene expression.

```{r fig-ge-cl-boxplot, fig.cap = "A boxplot of gene expression for each cell line (wild-type and cell-type 101)."}
data_long %>%
  ggplot(aes(x = CL, y = GE, col = CL)) +
  geom_boxplot() +
  theme(legend.position = 'none') +
  harrypotter::scale_color_hp_d("Ravenclaw") +
  labs(x = "Cell line",
       y = "Gene expression")
```

A boxplot of gene expression, grouped by cell line, is shown in @fig-ge-cl-boxplot. From this boxplot, it can be seen that there does not appear to be a significant difference between gene expression for wild-type and gene expression for cell-type 101. This suggests that cell line is not a predictor of gene expression.

```{r fig-ge-treat-boxplot, fig.cap = "A boxplot of gene expression for each treatment (placebo and activating factor 42)."}
data_long %>%
  ggplot(aes(x = treatment, y = GE, col = treatment)) +
  geom_boxplot() +
  theme(legend.position = 'none') +
  harrypotter::scale_color_hp_d("Ravenclaw") +
  labs(x = "Treatment",
       y = "Gene expression")
```

@fig-ge-treat-boxplot shows a boxplot of gene expression for each treatment type (placebo or activating factor 42). From this boxplot, it can be seen that there does appear to be a difference between gene expression for placebo and gene expression for activating factor 42. This suggests that treatment is a predictor of gene expression.

**REPEATED MEASURES HERE**
Given that the gene expression for each cell line and treatment was measured for different concentrations on the same bacteria, then this must be taken into account in fitting models on the data. Four models are compared (all with random effects for the gene line):

-   gene expression ~ concentration
```{r}
m1 <- lmer(GE ~ concentration + (1|GL), data = data_long, na.action = na.omit)
summary(m1)
```

-   gene expression ~ concentration * treatment
```{r}
m2 <- lmer(GE ~ concentration*treatment + (1|GL), data = data_long, na.action = na.omit)
summary(m2)
```

-   gene expression ~ concentration * treatment + cell line
```{r}
m3 <- lmer(GE ~ concentration*treatment + CL + (1|GL), data = data_long, na.action = na.omit)
summary(m3)
```

-   gene expression ~ concentration * treatment * cell line
```{r}
m4 <- lmer(GE ~ concentration*treatment*CL + (1|GL), data = data_long, na.action = na.omit)
summary(m4)
```

```{r}
AIC(m1, m2, m3, m4)
```
These four models can be compared using AIC, which shows that the model with interaction terms between concentration, treatment and cell line has the best AIC, but given that cell line does not appear to be important in predicting gene expression in @fig-ge-conc-grouping and @fig-ge-cl-boxplot, then this is likely a case of overfitting, so the interaction terms with cell line should be removed. Without this model, the best models are those with an interaction term between concentration and treatment, with or without a cell line term. The model with the cell line term is slightly better than the model without that term. This suggests that this model may be better, however the difference is not great. **DO MORE HERE**





# Discussion

# Appendix: Code

```{r ref.label=knitr::all_labels()}
#| eval: false
#| echo: true
```

## Quarto

Quarto enables you to weave together content and executable code into a finished document. To learn more about Quarto see <https://quarto.org>.

## Running Code

When you click the **Render** button a document will be generated that includes both content and the output of embedded code. You can embed code like this:

```{r}
1 + 1
```

You can add options to executable code like this

```{r}
#| echo: false
2 * 2
```

The `echo: false` option disables the printing of code (only output is displayed).
