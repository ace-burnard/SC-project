---
title: "IMRaD report for Karl"
author: "Alexandra Stephenson"
date: today
format: 
  html:
    self-contained: true
    df-print: tibble
editor_options:
  chunk_output_type: console
execute:
  warning: false
  message: false
  echo: false
bibliography: references.bib
---

<!-- # A predictive model of gene expression -->

<!-- -   Y = gene expression -->

<!-- -   X = concentration (numerical), treatment (factor, 2 levels), cell line (factor, 2 levels) -->

<!-- -   grouping = sheet names -->

```{r}
pacman::p_load(tidyverse, readr, lme4, knitr)
theme_set(theme_light())
data <- read_csv("data/2023-03-01_gene-data.csv")
data_long <- data %>%
  mutate(CL = `cell line`,
         treat = treatment) %>%
  unite(`cell line`, `treat`, sep = "; ", col = "grouping") %>%
  pivot_longer(cols = 4:14, names_to = "concentration", values_to = "GE") %>%
  filter(GE >= 0) %>%
  mutate(concentration = as.integer(concentration),
         GL = as.factor(sheet_names),
         CL = as.factor(CL),
         treatment = as.factor(treatment),
         grouping = as.factor(grouping))
```

<!-- ```{r} -->
<!-- test1 <- lmer(GE ~ concentration + (1|GL), data = data_long, na.action = na.omit) -->
<!-- summary(test1) -->
<!-- test2 <- lmer(GE ~ concentration + treatment*CL + (1|GL), data = data_long, na.action = na.omit) -->
<!-- summary(test2) -->
<!-- test3 <- lmer(GE ~ concentration*treatment*CL + (1|GL), data = data_long, na.action = na.omit) -->
<!-- summary(test3) -->
<!-- test4 <- lmer(GE ~ concentration*treatment + (1|GL), data = data_long, na.action = na.omit) -->
<!-- summary(test4) -->
<!-- test5 <- lmer(GE ~ concentration*treatment + CL + (1|GL), data = data_long, na.action = na.omit) -->
<!-- summary(test5) -->
<!-- AIC(test1, test2, test3, test4, test5) -->
<!-- BIC(test1, test2, test3, test4, test5) -->
<!-- ``` -->
<!--  -->
<!-- Cell line does not appear (from the EDA plots) to have a large impact on the slope of `GE ~ concentration`, so removing the interaction terms with cell line (lower AIC and BIC may just be due to overfitting). Removing this option leaves `GE ~ concentration + (1|GL)`, `GE ~ concentration*treatment + (1|GL)` and `GE ~ concentration*treatment + CL + (1|GL)` as the possible models. Of these, the last two models have the best AIC and BIC. However, there is not much difference between the AIC and BIC for these two models, so the model with fewer degrees of freedom is chosen: `GE ~ concentration*treatment + (1|GL)`. **CHECK THIS** -->

# Introduction
The data set consists of eight gene lines, each with one of two cell lines (wild-type or cell-type 101), one of two treatments (the placebo treatment or activating factor 42), and eleven different concentrations of growth factor (recorded in mg/ml). Thus, for each pair of cell line and treatment, there are two gene lines, each with eleven concentrations of growth factor (from $0$ to $10$). Only one data point is missing, that of concentration $5$ mg/ml for gene line GL-fUg (with cell line wild-type and treatment activating factor 42). 

This report investigates models for predicting gene expression based on concentration, cell line and treatment (or a subset of these predictors), as well as taking into account the effect of gene line.

# Method

The data was cleaned and analysed using the R language [@r-2022], and the packages ggpubr [@ggpubr], ggrepel [@ggrepel], knitr [@knitr], lme4 [@lme4], patchwork [@patchwork], readr [@readr], rstatix [@rstatix], showtext [@showtext], and tidyverse [@tidyverse]. Any data points recorded as $-99$ were taken to indicate no data was recorded, or `NA`.

Exploratory data analysis was then conducted on the data, including plotting gene expression versus concentration, gene expression versus cell line, and gene expression versus treatment.

Several mixed effects models were then fit, and compared using Akaike's Information Criterion (AIC).

-   R language [@r-2022]
-   tidyverse [@tidyverse]
-   rstatix [@rstatix]
-   ggpubr [@ggpubr]
-   patchwork [@patchwork]
-   showtext [@showtext]
-   ggrepel [@ggrepel]
-   lme4 [@lme4]
-   readr [@readr]
-   knitr [@knitr]

# Results

**ASSUMPTIONS CHECKING**

```{r fig-ge-conc-grouping, fig.cap = "A plot of gene expression as a function of concentration, coloured by cell line (wild-type or cell-type 101) and treatment (placebo or activating factor 42)."}
data_long %>%
  ggplot(aes(x = concentration, y = GE, color = grouping)) +
  geom_point() +
  ylim(0, NA) +
  harrypotter::scale_color_hp_d("Ravenclaw") +
  labs(x = "Concentration (mg/ml)",
       y = "Gene expression",
       color = "Cell Line; Treatment")
```

The data is plotted in @fig-ge-conc-grouping, with gene expression on the y axis and concentration on the x axis, with the data points coloured by cell line and treatment. From this plot, it can be seen that there appear to be differences between (cell-type 101, placebo) and (wild-type, placebo) and the other two pairs of cell line and treatment. However, there does not appear to be a difference between (cell-type 101, activating factor 42) and (wild-type, activating factor 42). This suggests that for the placebo treatment, cell line has an impact on gene expression, but for the activating factor, cell line may not have an impact on gene expression. From @fig-ge-conc-grouping, it can be seen that there does appear to be a relationship between concentration and gene expression, which suggests that concentration is a predictor of gene expression.

```{r fig-ge-cl-boxplot, fig.cap = "A boxplot of gene expression for each cell line (wild-type and cell-type 101)."}
data_long %>%
  ggplot(aes(x = CL, y = GE, col = CL)) +
  geom_boxplot() +
  theme(legend.position = 'none') +
  harrypotter::scale_color_hp_d("Ravenclaw") +
  labs(x = "Cell line",
       y = "Gene expression")
```

A boxplot of gene expression, grouped by cell line, is shown in @fig-ge-cl-boxplot. From this boxplot, it can be seen that there does not appear to be a significant difference between gene expression for wild-type and gene expression for cell-type 101. This suggests that cell line is not a predictor of gene expression.

```{r fig-ge-treat-boxplot, fig.cap = "A boxplot of gene expression for each treatment (placebo and activating factor 42)."}
data_long %>%
  ggplot(aes(x = treatment, y = GE, col = treatment)) +
  geom_boxplot() +
  theme(legend.position = 'none') +
  harrypotter::scale_color_hp_d("Ravenclaw") +
  labs(x = "Treatment",
       y = "Gene expression")
```

@fig-ge-treat-boxplot shows a boxplot of gene expression for each treatment type (placebo or activating factor 42). From this boxplot, it can be seen that there does appear to be a difference between gene expression for placebo and gene expression for activating factor 42. This suggests that treatment is a predictor of gene expression.

**REPEATED MEASURES HERE**
Given that the gene expression for each cell line and treatment was measured for different concentrations of growth factor for the same gene line, then this must be taken into account in fitting models on the data. 

A model can be fitted for gene expression as a function of concentration, with gene line as a random effect. The residuals plot with this model is shown in @fig-m1-plot. From this figure, it can be seen that there is still variance not explained by concentration alone, so this model will not be considered further.

```{r fig-m1-plot, fig.cap = "The residuals plot for the model of gene expression as a function of concentration, with gene line as a random effect."}
m1 <- lmer(GE ~ concentration + (1|GL), data = data_long, na.action = na.omit)
summary(m1)
plot(m1)
```

The next model considered fits gene expression as a function of concentration and treatment (with interaction terms), as well as gene line as a random effect. The residuals plot for this model is shown in @fig-m2-plot. 

```{r fig-m2-plot, fig.cap = "The residuals plot for the model of gene expression as a function of concentration and treatment (with interaction terms), with gene line as a random effect."}
m2 <- lmer(GE ~ concentration*treatment + (1|GL), data = data_long, na.action = na.omit)
summary(m2)
plot(m2)
```

Including cell line as a predictor, two models are fitted. One with interaction terms between concentration and treatment only, and one with interaction terms between concentration, treatment and cell line. The residuals plots for these models are shown in @fig-m3-plot and @fig-m4-plot, respectively.

```{r fig-m3-plot, fig.cap = "The residuals plot for the model of gene expression as a function of concentration and treatment (with interaction terms) and cell line (without any interaction terms), with gene line as a random effect."}
m3 <- lmer(GE ~ concentration*treatment + CL + (1|GL), data = data_long, na.action = na.omit)
summary(m3)
plot(m3)
```
```{r fig-m4-plot, fig.cap = "The residuals plot for the model of gene expression as a function of concentration, treatment and cell line (with interaction terms between all three predictors), with gene line as a random effect."}
m4 <- lmer(GE ~ concentration*treatment*CL + (1|GL), data = data_long, na.action = na.omit)
summary(m4)
plot(m4)
```

The residuals plots in @fig-m2-plot and @fig-m3-plot both appear to not have any residual variance, whilst the residuals plot for the model with interaction terms between all three predictors (in @fig-m4-plot) appears to possibly have some residual variance. **CHECK THIS** 

<!-- Four models are compared (all with random effects for the gene line): -->

<!-- -   gene expression ~ concentration -->

<!-- -   gene expression ~ concentration * treatment -->

<!-- -   gene expression ~ concentration * treatment + cell line -->

<!-- -   gene expression ~ concentration * treatment * cell line -->

<!-- The residuals for each model are plotted in @fig-m1-plot, @fig-m2-plot, @fig-m3-plot and @fig-m4-plot. From @fig-m1-plot, it can be seen that there is still variance not explained by concentration alone, so this model will not be considered further.  -->
<!-- The residuals plots for the model with concentration and treatment as predictors (with interaction terms), with or without cell line as another predictor (without interaction terms), in @fig-m2-plot and @fig-m3-plot, both appear not to have any residual variance in them, whilst the residuals plot (in @fig-m4-plot) for the model with concentration, treatment and cell line as predictors (with interactions between all three) appears to possibly have some residual variance. **CHECK THIS**  -->

```{r}
#| label: tbl-AIC-m1234
#| tbl-cap: "The AIC for each of the three fitted models."
kable(AIC(m2, m3, m4))
```
These three models can be compared using AIC (shown in @tbl-AIC-m1234), which shows that the model with interaction terms between concentration, treatment and cell line has the best AIC, but given that cell line does not appear to be important in predicting gene expression in @fig-ge-conc-grouping and @fig-ge-cl-boxplot, then this is likely a case of overfitting, so the interaction terms with cell line should be removed. Without this model, the best models are those with an interaction term between concentration and treatment, with or without a cell line term. The model with the cell line term is slightly better than the model without that term. This suggests that this model may be better, however the difference is not great. **DO MORE HERE** The model with only concentration as a predictor of gene expression has a much greater AIC than any of the other models, so this model is definitely not the best model for gene expression.

```{r}
pacman::p_load(performance)
compare_performance(m2,m3,m4)
```


# Discussion


# Appendix: Code

```{r ref.label=knitr::all_labels()}
#| eval: false
#| echo: true
```
